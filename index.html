DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анкеты</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
</head>
<body>
    <header>
        <h1>Взгляд в будущее</h1>
    </header>

    <main>
        <!-- Твоя оригинальная кнопка -->
        <button id="openFormBtn" class="add-btn">Создать анкету</button>

        <!-- Оригинальная форма (скрытая) -->
        <div id="form-container" style="display: none;">
            <h2>Добавить анкету</h2>
            <input type="text" id="nameInput" placeholder="Имя"><br>
            <input type="text" id="descInput" placeholder="Описание"><br>
            <input type="number" id="priceInput" placeholder="Цена за 1 час (₽)"><br>
            <input type="file" id="photoInput"><br>
            <button id="saveBtn">Сохранить</button>
            <button id="closeFormBtn">Отмена</button>
        </div>

        <!-- Здесь будут загруженные анкеты -->
        <h2>Список анкет</h2>
        <div id="profiles-container" class="container"></div>
    </main>

    <script>
        // Подключение к Appwrite
        const client = new Appwrite.Client();
        client.setEndpoint("https://cloud.appwrite.io/v1")
              .setProject("67c5f7c100327cf444d4");

        const database = new Appwrite.Databases(client);
        const storage = new Appwrite.Storage(client);
        const databaseId = "67c612a50017aa7ec1cd";
        const collectionId = "67c612be003cad091ef8";

        // Функция показа формы (вернул твою логику)
        document.getElementById("openFormBtn").addEventListener("click", function() {
            document.getElementById("form-container").style.display = "block";
        });

        // Функция скрытия формы
        document.getElementById("closeFormBtn").addEventListener("click", function() {
            document.getElementById("form-container").style.display = "none";
        });

        // Функция загрузки анкет из Appwrite
        async function loadProfiles() {
            try {
                const response = await database.listDocuments(databaseId, collectionId);
                const profilesContainer = document.getElementById("profiles-container");
                profilesContainer.innerHTML = ""; // Очищаем контейнер перед загрузкой

                if (response.documents.length === 0) {
                    profilesContainer.innerHTML = "<p>Анкет пока нет.</p>";
                    return;
                }

                response.documents.forEach(profile => {
                    profilesContainer.innerHTML += `
                        <div class="profile">
                            <img src="${profile.image}" alt="Фото анкеты">
                            <h3>${profile.name}</h3>
                            <p>${profile.description}</p>
                            <p><strong>Цена:</strong> ${profile.price} ₽/час</p>
                            <a href="profile.html?id=${profile.$id}" class="button">Подробнее</a>
                        </div>`;
                });
            } catch (error) {
                console.error("Ошибка загрузки анкет:", error);
                document.getElementById("profiles-container").innerHTML = "<p>Ошибка загрузки анкет.</p>";
            }
        }

        // Функция загрузки анкеты в Appwrite
        document.getElementById("saveBtn").addEventListener("click", async function() {
            let file = document.getElementById("photoInput").files[0];
            let name = document.getElementById("nameInput").value.trim();
            let desc = document.getElementById("descInput").value.trim();
            let price = document.getElementById("priceInput").value.trim();

            if (!file || !name || !desc || !price) {
                alert("Заполните все поля!");
                return;
            }

            try {
                // Загружаем фото в Appwrite Storage
                const uploadResponse = await storage.createFile("default", "unique()", file);
                const fileId = uploadResponse.$id;

                // Получаем URL загруженного фото
                const fileUrl = `https://cloud.appwrite.io/v1/storage/buckets/default/files/${fileId}/view?project=67c5f7c100327cf444d4`;

                // Сохраняем анкету в Appwrite Database
                await database.createDocument(databaseId, collectionId, "unique()", {
                    name: name,
                    description: desc,
                    price: parseInt(price),
                    image: fileUrl
                });

                alert("Анкета успешно добавлена!");
                document.getElementById("form-container").style.display = "none"; // Закрываем форму
                loadProfiles(); // Обновляем список анкет
            } catch (error) {
                console.error("Ошибка загрузки:", error);
                alert("Ошибка при загрузке анкеты.");
            }
        });

        // Загружаем анкеты при загрузке страницы
        loadProfiles();
    </script>
</body>
</html>

